<script type="text/x-red" data-template-name="interruptin">
    <div class="form-row">
        <label for=""><i class="fa fa-microchip"></i> Board</label>
        <select id="node-input-board" type="text">
            <option value="">select deploy board ...</option>
            <option value="RAVEN">RAVEN</option>
            <option value="SBB">SBB</option>
        </select>
        <input type="hidden" id="node-input-pin">
    </div>
    <div class="form-row sbb hidden" id="pin-name-sbb">
        <label for=""><i class="fa fa-bolt"></i> Pin</label>
        <select type="text" id="sbb-pin">
            <option value="PTE24">GRV I2C - SIG1</option>
            <option value="PTE25">GRV I2C - SIG2</option>
            <option value="A4">GRV I/O - SIG1</option>
            <option value="A5">GRV I/O - SIG2</option>
            <option value="PTC4">SBB SWRIGHT</option>
            <option value="PTD0">SBB SWLEFT</option>
            <option value="PTC6">K64F SW2</option>
            <option value="PTA4">K64F SW3</option>
        </select>
    </div>
    <div class="form-row raven hidden" id="pin-name-raven">
        <label for=""><i class="fa fa-bolt"></i> Pin</label>
        <select type="text" id="raven-pin">
            <option value="GRV11">PORT1 - SIG1</option>
            <option value="GRV12">PORT1 - SIG2</option>
            <option value="GRV21">PORT2 - SIG1</option>
            <option value="GRV22">PORT2 - SIG2</option>
            <option value="GRV31">PORT3 - SIG1</option>
            <option value="GRV32">PORT3 - SIG2</option>
            <option value="GRV41">PORT4 - SIG1</option>
            <option value="GRV42">PORT4 - SIG2</option>
            <option value="USWITCH">USER SW</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-mode"><i class="fa fa-toggle-on"></i> mode</label>
        <select type="text" id="node-input-mode">
            <option value=3>pullup</option>
            <option value=1>pulldown</option>
            <option value=0>pullnone</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-trigger"><i class="fa fa-sign-in"></i> trigger</label>
        <select type="text" id="node-input-trigger">
            <option value="rise">rise</option>
            <option value="fall">fall</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('interruptin', {
        category: 'EEA',
        color: '#91b122',
        defaults: {
            board: { value: '' },
            pin: { value: 'PTA4' },
            mode: { value: 3 },
            trigger: { value: 'rise' },
            name: { value: '' }
        },
        inputs: 0,
        outputs: 1,
        icon: 'serial.png',
        label: function () {
            return this.name || 'interruptin';
        },
        button: {
            onclick: function () {
                var label = (this.name || 'InterruptIn');
                if (label.length > 30) {
                    label = label.substring(0, 50) + "...";
                }
                label = label.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                var node = this;
                $.ajax({
                    url: "inject/" + this.id,
                    type: "POST",
                    success: function (resp) {
                        RED.notify(node._("inject.success", { label: label }), "success");
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("INJECT_ERROR!!!");
                        if (jqXHR.status == 404) {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                        } else if (jqXHR.status == 500) {
                            RED.notify(node._("common.notification.error", { message: node._("inject.errors.failed") }), "error");
                        } else if (jqXHR.status == 0) {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                        } else {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                        }
                    }
                });
            }
        },
        oneditprepare: function () {
            $("#node-input-board").change(function () {
                var _board = $("#node-input-board").val();
                if (_board == "SBB") {
                    $("#pin-name-raven").hide();
                    $("#pin-name-sbb").show();
                } else if (_board == "RAVEN") {
                    $("#pin-name-sbb").hide();
                    $("#pin-name-raven").show();
                } else {
                    $("#pin-name-sbb").hide();
                    $("#pin-name-raven").hide();
                }
            })
            $("#sbb-pin").val($("#node-input-pin").val());
            $("#raven-pin").val($("#node-input-pin").val());
        },
        oneditsave: function () {
            var _board = $("#node-input-board").val();
            if (_board == "SBB") {
                $("#node-input-pin").val($("#sbb-pin").val());
            } else if (_board == "RAVEN") {
                $("#node-input-pin").val($("#raven-pin").val());
            } else {
                $("#node-input-pin").val('');
            }
        }
    });
</script>

<script type="text/x-red" data-help-name="interruptin">
    
    <p> Start flow by interrupt in. This node is for enebular-edge-agent. </p>

    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">string</span></dt>
        <dd>The value ("high" or "low") of pin signal.</dd>
        <dt>topic<span class="property-type">string</span></dt>
        <dd>The pin name interrupting in. * This name is controlled by micro board. So it is different from node config value.</dd>
    </dl>

    <h3>Details</h3>
    
    <h4>Setting items</h4>
    <ul>
        <li><code>Board</code>： Target board.*1</li>
        <li><code>Pin</code>： Target pin.*1</li>
        <li><code>Mode</code>: Set `pullUp`/`pullDown`/`pullNone` according to the electronic circuit</li>
        <li><code>Trigger</code>: The trigger signal rise or fall.</li>
    </ul>
      <p>*1 See below about <code>Board</code> and <code>Pin</code>.</p>

    <h4>Operation on flow editor</h4>
    <p>On flow editor, the nodes for enebular-edge-agent doesn't output value read by module but dummy value on flow editor.</p>
    <p>Output format of the value is equal to on the module. So, able to edit flow by using dummy value.</p>
    <p>In this node, press left botton to start flow.</p>

    <h4>About enebular-edge-agent</h4>

    <p>enebular-edge-agent operates on RAVEN and SBB. Please refer to the following to set the board pin assignment. Deploying settings of different boards Flow is not executed.</p>
    
    <h5>RAVEN</h5>
    <img src="icons/node-red-contrib-enebular/eea_fig_v2.png">
    
    <h5>SBB</h5>
    <img src="icons/node-red-contrib-enebular/eea_fig_v1.png">
</script>